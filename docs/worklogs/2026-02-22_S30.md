# Session 30 — 2026-02-22

## Context
- **Phase**: Phase 2.5: BarrierNet Experiment — Session 5 (GPU Training Deployment + Evaluation Framework)
- **Branch**: main

## Objectives
- [x] Deploy codebase to niro-2 (RTX 5090)
- [x] Install dependencies on niro-2 (venv, PyTorch CUDA 12.8, qpth, etc.)
- [x] Launch full BarrierNet training (2M steps, 2 seeds)
- [x] Build comparison framework for BarrierNet vs CBF-Beta evaluation
- [x] Create monitoring + auto-evaluation scripts
- [ ] Training in progress (~10.6h estimated per run)

## Work Done

### Deployment to niro-2
- Pushed code to GitHub (da0f63b → c535aaa)
- Cloned repo on niro-2 (`~/Codes/safe-rl-pe`)
- Created Python venv with:
  - PyTorch 2.10.0+cu128 (CUDA available, RTX 5090)
  - qpth 0.0.18, numpy 2.4.2 (upgraded from qpth's 1.26.4 requirement)
  - gymnasium, stable-baselines3, scipy, omegaconf, tensorboard, etc.
- All 103 BarrierNet tests pass on niro-2

### Training Launch
- Benchmarked: ~19ms/step, estimated 10.6h for 2M steps
- Launched 2 training runs:
  - Seed 42 (PID 1876901): `--timesteps 2000000 --obstacles 2 --seed 42`
  - Seed 123 (PID 1894320): `--timesteps 2000000 --obstacles 2 --seed 123`
- Early metrics (5 iterations):
  - 0% infeasibility throughout
  - QP solve time: 4-15ms (single process) to 35ms (when both running)
  - Intervention rate: ~82-97% (expected for untrained network)
  - Policy loss decreasing, critic loss decreasing

### Comparison Framework
- `evaluation/comparison_framework.py`:
  - `EvaluationResult` dataclass with all metrics
  - `BarrierNetEvalAgent` — wraps BarrierNetPPO for evaluation
  - `SB3EvalAgent` — wraps SB3 PPO model with optional VCPCBFFilter
  - `evaluate_approach()` — runs N episodes, computes safety/task/QP metrics
  - `compute_comparison()` — generates ComparisonReport with statistical tests
  - `format_comparison_table()` — markdown comparison table
  - CBF margin computation using existing VCP-CBF functions
- `scripts/evaluate_comparison.py`:
  - CLI for BarrierNet vs CBF-Beta comparison
  - Supports `--barriernet-only` mode for BarrierNet evaluation
  - Saves results to JSON for reproducibility
- `tests/test_comparison_framework.py`: 21 tests, all pass
- `scripts/monitor_training.sh`: Auto-monitors training + runs evaluation

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `evaluation/__init__.py` | Created | Package init |
| `evaluation/comparison_framework.py` | Created | Comparison framework (501 lines) |
| `scripts/evaluate_comparison.py` | Created | CLI comparison script |
| `scripts/monitor_training.sh` | Created | Training monitor + auto-eval |
| `tests/test_comparison_framework.py` | Created | 21 evaluation tests |
| `docs/worklogs/2026-02-22_S30.md` | Created | Session worklog |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Run 2 seeds (42, 123) for statistical robustness | Need multiple runs for meaningful comparison |
| CPU training (not GPU) | qpth QP solve is CPU-bound; GPU only helps for batch PPO updates |
| Auto-eval via monitor script | Training takes ~10h; evaluation should run automatically |
| Compute CBF margins during evaluation | Needed for safety violation tracking, uses existing vcp_cbf functions |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| Python externally-managed (niro-2 Ubuntu 24.04) | Created venv in `.venv/` |
| numpy downgraded to 1.26.4 by qpth | `pip install "numpy>=2.0"` — qpth works fine with numpy 2.x |
| Python output buffering (nohup) | Relaunched with `python3 -u` for unbuffered output |
| `$!` shell expansion in SSH | Used heredoc (`<< 'ENDSSH'`) to prevent local expansion |
| CPU contention with 2 training runs | QP time increased from 5ms to 35ms; acceptable for overnight runs |

## Next Steps
- [ ] Training completes (~10h from launch, ETA ~4pm local)
- [ ] Auto-evaluation runs (200 episodes per seed)
- [ ] Session 6: Full comparison with CBF-Beta (requires CBF-Beta trained model)
- [ ] Session 7: Decision analysis document

## Metrics
- Files created: 5
- Tests added: 21 (total: 478)
- Training launched: 2 runs × 2M steps on niro-2 RTX 5090
- Commits: 839f8ff, c535aaa
