# Session 27 — 2026-02-22

## Context
- **Phase**: Phase 2.5: BarrierNet Experiment — Session 2 (Differentiable QP Layer)
- **Branch**: main

## Objectives
- [x] Install qpth differentiable QP solver
- [x] Implement `safety/differentiable_qp.py` — DifferentiableVCPCBFQP using qpth
- [x] Implement batched torch constraint building (arena + obstacle + collision)
- [x] Write comprehensive unit tests (`tests/test_differentiable_qp.py`)
- [x] Verify gradient flow through QP layer
- [x] Benchmark QP solve time for our problem size

## Work Done

### Installing qpth
- Installed qpth v0.0.18 (also pulled in cvxpy, clarabel, osqp, scs as dependencies)
- Verified qpth works with numpy 2.x despite declared incompatibility
- Verified basic QP solve: `QPFunction()(Q, p, G, h, A, b)` works correctly

### Implementing DifferentiableVCPCBFQP
- Created `safety/differentiable_qp.py` — core differentiable QP layer
- `DifferentiableVCPCBFQP(nn.Module)`: wraps qpth's `QPFunction` for VCP-CBF
  - `build_constraint_matrices()`: Builds batched G, h matrices from states/obstacles/opponents
  - `forward()`: Solves batched QP with anisotropic weights (w_v=150, w_omega=1)
  - `compute_constraint_values()`: Verifies CBF margins for debugging
- Constraint format matches existing `safety/vcp_cbf.py` exactly:
  - Arena: 4 boundary constraints (right, left, top, bottom walls)
  - Obstacles: circular CBF with effective_r = obs_radius + robot_radius
  - Collision: inter-robot VCP-based collision avoidance
- Inactive constraints padded with h=1e6 (always satisfied)
- Control bounds encoded as 4 additional inequality constraints
- `verify_numpy_torch_consistency()`: debugging utility comparing torch vs numpy outputs

### Unit Tests (50 tests, 9 test classes)
- `TestConstraintMatrixConstruction` (7 tests): shapes, padding, control bounds, batching
- `TestNumpyTorchConsistency` (11 tests): arena, obstacle, collision, parametrized headings/positions
- `TestQPForwardPass` (6 tests): safe/unsafe actions, obstacle/collision avoidance, bounds
- `TestGradientFlow` (5 tests): gradient existence, nonzero, active constraints, PPO loss
- `TestBatchConsistency` (2 tests): shape, single-vs-batch agreement
- `TestConstraintSatisfaction` (3 tests): arena, obstacle, random state satisfaction
- `TestPerformance` (3 tests): single/batch solve time, constraint build time
- `TestEdgeCases` (6 tests): zero action, origin, no obstacles, many obstacles, negative heading
- `TestIntegrationWithVCPCBF` (3 tests): center safe, wall correction, obstacle correction agreement

### Performance Benchmarks
| Benchmark | Result | Target |
|-----------|--------|--------|
| Single QP solve | 2.5ms | <5ms |
| Batch-32 solve | 12ms (0.38ms/sample) | <500ms |
| Constraint build (B=64) | 0.22ms | <10ms |

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `safety/differentiable_qp.py` | Created | Differentiable QP layer using qpth for VCP-CBF |
| `tests/test_differentiable_qp.py` | Created | 50 unit tests across 9 test classes |
| `docs/worklogs/2026-02-22_S27.md` | Created | Session worklog |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Use continuous-time CBF formulation (matching vcp_cbf.py) | Consistency with existing codebase; our VCP gives relative degree 1 making constraints already linear |
| qpth with weighted Q matrix for anisotropic costs | Match existing w_v=150, w_omega=1 weighting from Phase 2 |
| Infeasibility fallback returns clamped nominal + detached gradient | Prevents NaN gradients while maintaining safety |
| Allow qpth ~0.1 constraint tolerance in tests | PDIPM is approximate; small violations acceptable (max observed: 0.06) |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| qpth declares numpy<2 requirement | Works fine with numpy 2.x in practice, ignored warning |
| qpth PDIPM gives small constraint violations (~0.06) | Acceptable for interior point solver; tests use 0.1 tolerance |
| `~bool` deprecation warning in Python 3.16 | Changed to `not` operator |

## Next Steps
- [ ] Session 3: Create BarrierNet actor network (backbone + mean head + QP layer)
- [ ] Session 3: Integrate stochastic pre-QP sampling for PPO exploration
- [ ] Session 3: Modify PPO to handle deterministic post-QP output

## Metrics
- Files created: 2
- Tests added: 50
- Tests passing: 382/386 (4 pre-existing omegaconf failures)
- QP solve: 2.5ms single, 0.38ms/sample batched
