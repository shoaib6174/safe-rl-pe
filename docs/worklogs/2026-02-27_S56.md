# Session 56 — 2026-02-27

## Context
- **Phase**: Phase 3 — Partial Observability & Self-Play
- **Focus**: Fix opponent pool eviction + convergence hardening after RA1/RA2 collapse

## Objectives
- [x] Add reservoir sampling to OpponentPool (replaces FIFO default)
- [x] Add `convergence_consecutive` param to AMSDRLSelfPlay (separate from `ne_gap_consecutive`)
- [x] Add `--convergence_consecutive` CLI arg to train_amsdrl.py
- [x] Update tests for new behavior + 9 new tests
- [x] Create worklog + update workflow tracker

## Work Done

### 1. Reservoir Sampling in OpponentPool
- Added `eviction_strategy` param ("reservoir" default, "fifo" for backward compat)
- Added `_total_added` counter for reservoir probability calculation
- When pool full + reservoir: accept new checkpoint with probability `max_size / _total_added`, replace random existing entry
- When pool full + FIFO: evict oldest (existing behavior)
- Validation: raises `ValueError` for invalid strategy
- Updated `__repr__` to show `strategy=` and `total_added=`

### 2. Convergence Hardening in AMSDRLSelfPlay
- Added `convergence_consecutive: int = 5` parameter (was reusing `ne_gap_consecutive` which defaults to 2)
- Root cause of premature convergence: RA2 hit equilibrium at M200, declared convergence after just 2 balanced evals (transient), then strong pursuer snapshots were evicted from FIFO pool, evader dominated permanently
- Fixed `_run_micro_phases()` convergence check to use `self.convergence_consecutive`
- Passes `eviction_strategy="reservoir"` to both pool creations
- Updated micro-phase banner to show convergence requirement and pool strategy

### 3. CLI Update
- Added `--convergence_consecutive` (default 5) to `scripts/train_amsdrl.py`
- Passed through to AMSDRLSelfPlay constructor

### 4. Test Updates
- Renamed `test_fifo_eviction` → `test_fifo_eviction_strategy` with explicit `eviction_strategy="fifo"`
- Added `eviction_strategy="fifo"` to `test_eviction_clears_cache` for determinism
- New tests:
  - `test_invalid_eviction_strategy` — ValueError on bad strategy
  - `test_default_strategy_is_reservoir` — reservoir is default
  - `test_reservoir_never_exceeds_max_size` — 200 adds, always ≤ max
  - `test_reservoir_uniform_coverage` — statistical test (5000 trials, early/mid/late groups within 0.3-1.7x expected)
  - `test_reservoir_eviction_clears_cache` — no stale cache entries after evictions
  - `test_total_added_tracks_all_offers` — counter correctness
  - `test_amsdrl_pools_use_reservoir_strategy` — integration
  - `test_amsdrl_convergence_consecutive_default` — default=5
  - `test_amsdrl_convergence_consecutive_custom` — custom value accepted

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `training/opponent_pool.py` | Modified | Reservoir sampling, eviction_strategy, _total_added, updated __repr__ |
| `training/amsdrl.py` | Modified | convergence_consecutive param, pool reservoir strategy, banner updates |
| `scripts/train_amsdrl.py` | Modified | --convergence_consecutive CLI arg |
| `tests/test_opponent_pool.py` | Modified | 9 new tests, renamed FIFO test, explicit strategy in existing tests |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Reservoir default, FIFO opt-in | Reservoir preserves uniform history coverage; FIFO systematically destroys early strong opponents |
| convergence_consecutive=5 (not 2) | 2 was far too transient; 5 consecutive balanced evals gives confidence in genuine equilibrium |
| Separate from ne_gap_consecutive | ne_gap_consecutive controls curriculum advancement (should fire quickly); convergence controls training termination (should be strict) |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| 68 pre-existing test failures in barriernet/qp modules | Unrelated to this change, existed before S56 |

## Next Steps
- [ ] Push to GitHub, pull on niro-2
- [ ] Kill RA1/RA2 runs if still alive
- [ ] Launch RA3 (`--opponent_pool_size 50 --convergence_consecutive 5`) and RA4 (with curriculum)
- [ ] Monitor first 3 eval windows for pool diversity + convergence streak behavior

## Metrics
- Files changed: 4
- Tests added: 9 (696 total passing, was 687)
- Documents updated: 2 (worklog + tracker)
