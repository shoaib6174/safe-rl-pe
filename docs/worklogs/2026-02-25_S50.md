# Session 50 — 2026-02-25

## Context
- **Phase**: Phase 3: Self-Play Training & Obstacle Physics
- **Branch**: main

## Objectives
- [x] Implement physical obstacle collision enforcement (agents were passing through obstacles)
- [x] Add `resolve_obstacle_collisions()` function with radial projection
- [x] Integrate collision resolution into `step()` with arena re-clamping
- [x] Add `w_collision` penalty parameter threaded through training pipeline
- [x] Add unit tests (8) and integration tests (4)

## Work Done

### Physical Obstacle Collision Enforcement
- **Root cause**: `_check_obstacle_collision()` detected collisions but `step()` never corrected positions — obstacles were line-of-sight blockers only, not physical barriers
- **Fix**: Hard projection with tangential sliding — consistent with wall handling in `unicycle_step()`

### 1. `resolve_obstacle_collisions()` in `envs/dynamics.py`
- Added after `unicycle_step()`, follows same pattern (takes position, returns corrected position + flag)
- For each obstacle: if `dist(agent, obs_center) < obs_radius + robot_radius`, push agent radially outward to surface
- Iterates up to `max_iterations=3` for chain collisions
- Edge case: agent at obstacle center uses heading direction for push-out
- Heading (theta) never modified

### 2. Integration into `step()` in `envs/pursuit_evasion_env.py`
- Replaced detection-only code with `resolve_obstacle_collisions()` calls for both agents
- Added arena re-clamping after obstacle push (handles obstacle near boundary)
- Physics enforcement is unconditional — no parameter to disable

### 3. `w_collision` Penalty Parameter
- Added `w_collision: float = 0.0` to `PursuitEvasionEnv.__init__()`
- Per-agent penalty (not zero-sum), applied after `reward_computer.compute()`
- Default 0.0 for backward compatibility

### 4. Training Pipeline Threading
- `_make_partial_obs_env()`: added `w_collision` param, passes to `PursuitEvasionEnv`
- `AMSDRLSelfPlay.__init__()`: added `w_collision` param, stored in `self.env_kwargs`
- `_evaluate_head_to_head()` and `_evaluate_head_to_head_full_obs()`: added `w_collision`, passes to eval envs
- `scripts/train_amsdrl.py`: added `--w_collision` CLI arg

### 5. Tests (13 new)
- 9 unit tests in `TestResolveObstacleCollisions` (test_dynamics.py)
- 4 integration tests in `TestObstacleCollisionEnforcement` (test_obstacles.py)
- All 603 tests pass (68 pre-existing BarrierNet failures unchanged)

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `envs/dynamics.py` | Modified | Added `resolve_obstacle_collisions()` function (~50 lines) |
| `envs/pursuit_evasion_env.py` | Modified | Import new function, `w_collision` param, collision resolution in `step()`, penalty |
| `training/amsdrl.py` | Modified | Threaded `w_collision` through `_make_partial_obs_env`, `AMSDRLSelfPlay.__init__`, eval functions |
| `scripts/train_amsdrl.py` | Modified | Added `--w_collision` CLI arg |
| `tests/test_dynamics.py` | Modified | Added 9 unit tests for `resolve_obstacle_collisions()` |
| `tests/test_obstacles.py` | Modified | Added 4 integration tests for collision enforcement + penalty |
| `docs/worklogs/2026-02-25_S50.md` | Created | This worklog |
| `docs/workflow_tracker.md` | Modified | Added S50 entry |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Hard projection (not soft penalty only) | Standard in robotics venues; consistent with wall handling; pairs with future CBF work |
| Unconditional enforcement (no disable flag) | Obstacles must always be physical barriers — disabling would be a modeling error |
| `w_collision` default 0.0 | Backward compatible; physics enforcement works without reward penalty |
| Per-agent penalty (not zero-sum) | Both agents should be penalized for hitting obstacles independently |
| max_iterations=3 for chain resolution | Handles rare case of pushing into adjacent obstacle; 3 is sufficient for typical layouts |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| Multi-obstacle test with overlapping exclusion zones | Fixed test: used properly spaced obstacles where robot can fit between them |

## Next Steps
- [ ] Generate trajectory visualizations with Run R/S/T models to confirm agents no longer pass through obstacles
- [ ] Consider enabling `w_collision` in future training runs to discourage wall-hugging behavior
- [ ] Run training with obstacle collision enforcement to evaluate impact on learned policies

## Metrics
- Files changed: 8
- Tests added: 13 (9 unit + 4 integration)
- Tests passing: 603 (up from ~590)
