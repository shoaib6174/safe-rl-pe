# Session 42 — 2026-02-23

## Context
- **Phase**: Phase 3: Partial Observability & Self-Play — Session 5 (Curriculum Learning)
- **Prior**: Sessions 39-41 implemented sensors, BiMDN, AMS-DRL self-play. Runs E-G validated FixedSpeedWrapper. Gate 3 passed (77% capture in partial-obs). Run G showed arms race oscillation (min NE gap 0.14).

## Objectives
- [x] Implement CurriculumManager with 4-level progressive difficulty
- [x] Integrate curriculum into AMSDRLSelfPlay training loop
- [x] Add --curriculum CLI flag to train_amsdrl.py
- [x] Write comprehensive tests
- [x] Create session worklog

## Work Done

### CurriculumManager Implementation
- Created `training/curriculum.py` with `CurriculumManager` class
- 4 levels of progressive difficulty:
  - **Level 1**: Close range (2-5m), no obstacles (easiest)
  - **Level 2**: Medium range (5-15m), no obstacles
  - **Level 3**: Close range (2-5m), 3 obstacles
  - **Level 4**: Full scenario (2-15m), 3 obstacles (hardest)
- Arena-aware distance clamping: max distances scaled to 80% of arena diagonal to prevent impossible spawn configurations (critical for 10x10 arena where diagonal is ~14.14m)
- Advancement criterion: pursuer capture rate > 70% (configurable threshold)
- Level history tracking for analysis

### AMS-DRL Integration
- Added `curriculum` parameter to `AMSDRLSelfPlay.__init__`
- When enabled, Level 1 overrides are applied immediately to `env_kwargs`
- After each evaluation phase: curriculum checks advancement, updates `env_kwargs` and `n_obstacles`
- Curriculum level logged in history entries and final results
- Print output includes curriculum status

### CLI Flag
- Added `--curriculum` flag to `scripts/train_amsdrl.py`
- Passed through to AMSDRLSelfPlay constructor

### Tests
- Created `tests/test_curriculum.py` with 29 tests across 7 test classes:
  - TestCurriculumManagerInit (6 tests)
  - TestCurriculumLevels (6 tests)
  - TestArenaAwareClamping (3 tests)
  - TestCurriculumAdvancement (8 tests)
  - TestCurriculumStatus (3 tests)
  - TestCurriculumIntegration (3 tests)
- All 29 tests pass; full relevant suite (111 tests) passes

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `training/curriculum.py` | Created | CurriculumManager with 4-level progressive difficulty |
| `training/amsdrl.py` | Modified | Added curriculum parameter, level check after eval, status logging |
| `scripts/train_amsdrl.py` | Modified | Added --curriculum CLI flag |
| `tests/test_curriculum.py` | Created | 29 tests for curriculum manager and integration |
| `docs/worklogs/2026-02-23_S42.md` | Created | This worklog |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Fixed obstacle count per level (3) rather than ranges | PursuitEvasionEnv takes `n_obstacles` as int; ranges would require env modification. Simpler to use fixed mid-range values |
| Arena-aware distance clamping at 80% diagonal | Prevents impossible spawn configurations in small arenas (10x10 diagonal ≈ 14.14m, Level 2 wants 15m max) |
| Check advancement after every phase (not just pursuer) | Capture rate is always available from evaluation; checking after every phase gives faster level progression |
| Levels 3-4 with obstacles noted as future validation | Obstacles haven't been validated with current pipeline (n_obstacles=0 in all runs). Levels 3-4 will need validation when obstacles are integrated |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| None | Clean implementation session |

## Next Steps
- [ ] Run training with `--curriculum` to validate level progression
- [ ] Session 6: Scripted baseline diversity (already partially done in selfplay_callbacks.py)
- [ ] Session 7: Opponent pool / diversity mechanisms (addresses Run G oscillation)
- [ ] DCBF verification before Session 8 (integration & full eval)
- [ ] Final validation on 20x20 arena after all implementation complete

## Metrics
- Files changed: 5 (2 created, 2 modified, 1 worklog)
- Tests added: 29
- Total relevant tests passing: 111
