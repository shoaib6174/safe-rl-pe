# Session 51 — 2026-02-25

## Context
- **Phase**: Phase 3: Partial Observability & Self-Play
- **Branch**: main

## Objectives
- [x] Add `w_wall` wall collision penalty parameter (mirrors `w_collision` pattern from S50)
- [x] Research collision/wall penalty design: literature review, relation to safe RL/CBF, calibration

## Work Done

### `w_wall` Wall Collision Penalty
Added an optional per-agent wall collision penalty. Wall collisions are already physically enforced (`unicycle_step()` clips position), but there was no reward signal discouraging agents from pressing against walls. This mirrors the `w_collision` obstacle collision penalty added in S50.

- Default `0.0` for full backward compatibility
- Uses existing `p_wall`/`e_wall` booleans from `unicycle_step()` returns
- Per-agent penalty (not zero-sum), same pattern as `w_collision`

**Changes across 4 files:**
1. **`envs/pursuit_evasion_env.py`**: Added `w_wall` parameter to `__init__()`, stored as `self.w_wall`, added penalty block in `step()` after `w_collision`
2. **`training/amsdrl.py`**: Threaded `w_wall` through `_make_partial_obs_env()`, `AMSDRLSelfPlay.__init__()`, `_evaluate_head_to_head()`, `_evaluate_head_to_head_full_obs()`
3. **`scripts/train_amsdrl.py`**: Added `--w_wall` CLI argument, passed to `AMSDRLSelfPlay()`
4. **`tests/test_env.py`**: Added `TestWallPenalty` class with 2 tests

### Research: Collision & Wall Penalty Design
Comprehensive literature review on collision penalty magnitude, relation to CBF/safe RL, and calibration for our game setup. Reviewed 20+ papers from web search, 36 existing project papers, and 5 newly downloaded papers (N16–N20).

**Key findings:**
1. **Three paradigms**: reward-only, CBF-only, dual (CBF + reward). Dual is state-of-the-art.
2. **CBF + penalty is NOT redundant**: N17 (Yang et al. 2025) ablation proves dual approach (99.0%) outperforms filter-only (98.8%, drops to 38.7% without runtime filter) and reward-only (91.9%).
3. **Penalty magnitudes in literature**: obstacle/wall penalties range from -0.25 to -50, typically 0.5×–5× the goal reward. With CBFs active, smaller penalties suffice.
4. **Recommendation for our setup**: `w_wall = w_collision = 0.5` (14× per-step distance reward, 100 wall-steps = -50 = half of capture_bonus). Penalties >5.0 risk freezing behavior.

**5 new papers downloaded (N16–N20):**
- N16: Safe Finite-Time RL for PE (Kokolakis, CDC 2022) — barrier function (ψ=500) in PE cost
- N17: CBF-RL (Yang et al., 2025) — dual filter+reward, r_wall=-1.0, r_cbf weight=100
- N18: CBF-Safe Pursuit (Deng et al., 2024) — CBF-only QP filter, no penalty in reward
- N19: Large-Scale PE Collision Avoidance (Yang et al., IROS 2023) — f_c smooth proximity penalty + action masking
- N20: Survival Penalty Navigation (Jeng & Chiang, Sensors 2023) — argues against large penalties, uses episode concatenation

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `envs/pursuit_evasion_env.py` | Modified | Added `w_wall` param, storage, and penalty logic in `step()` |
| `training/amsdrl.py` | Modified | Threaded `w_wall` through 4 functions |
| `scripts/train_amsdrl.py` | Modified | Added `--w_wall` CLI arg and passthrough |
| `tests/test_env.py` | Modified | Added `TestWallPenalty` class (2 tests) |
| `docs/research_collision_wall_penalty.md` | Created | Full research report with literature review, analysis, recommendations |
| `papers/supplementary/N16–N20` | Downloaded | 5 new papers on collision penalties & CBF-RL |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Default `w_wall=0.0` | Backward compatibility — existing runs unaffected |
| Per-agent (not zero-sum) | Matches `w_collision` pattern; wall penalty is a shaping signal, not part of the game reward |
| Recommend `w_wall=w_collision=0.5` | 14× per-step distance reward; not so large as to cause freezing (literature warns >5.0 risks agent paralysis) |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| None | — |

## Next Steps
- [ ] Run experiments with `w_wall=0.5, w_collision=0.5` and compare to baseline (0.0)
- [ ] Consider CBF-derived penalty (r_cbf from N17) as advanced alternative to fixed penalty
- [ ] Continue monitoring Runs S/T for self-play collapse

## Metrics
- Files changed: 6 (4 code + 1 report + 5 papers)
- Tests added: 2 (24 env tests total, 605 total passing)
- Papers downloaded: 5 (N16–N20)
- Commits: `e220a10` (w_wall impl), `4c9e42d` (worklog)
