# Session 23 — 2026-02-22

## Context
- **Phase**: Phase 2: Safety Integration — Session 6 (3-Tier Infeasibility Handling)
- **Branch**: main

## Objectives
- [x] Tier 2: Hierarchical constraint relaxation
- [x] Tier 3: Backup controller (emergency brake + turn)
- [x] Tier 1: FeasibilityClassifier (SVM-based)
- [x] SafeActionResolver integrating all 3 tiers
- [x] Tests for infeasibility handling
- [x] Full test suite passes

## Work Done

### Tier 3: Backup Controller (safety/infeasibility.py)
- `backup_controller(state, obstacles, ...)`: emergency action when all CBF tiers fail
- Finds nearest danger (walls or obstacle edges) via `_find_nearest_danger()`
- Turns away from danger: `omega = clip(3.0 * heading_error, -omega_max, omega_max)`
- Moves at 0.1 * v_max (very slow, survival-only)
- Helper `_find_nearest_danger()` considers 4 arena walls + all obstacle surfaces

### Tier 2: Hierarchical Relaxation (safety/infeasibility.py)
- `solve_cbf_qp_with_relaxation()`: tries progressively relaxed QP
- Priority order: all → drop OBSTACLE → drop ARENA → unconstrained fallback
- Uses existing `ConstraintType` enum (COLLISION=3 > ARENA=2 > OBSTACLE=1)
- Returns method string ('exact', 'relaxed_obstacles', 'relaxed_arena', 'unconstrained')
- Info dict includes `relaxed_types` list documenting which constraints were dropped

### Tier 1: FeasibilityClassifier (safety/infeasibility.py)
- SVM classifier (sklearn RBF kernel) predicts infeasible states
- `collect_data(state, is_feasible)`: records training samples during rollouts
- `train()`: fits SVM with balanced class weights; requires min_samples + both classes
- `is_feasible(state)`: binary prediction (optimistic=True before training)
- `get_feasibility_margin(state)`: decision_function → positive=feasible, negative=infeasible
- Graceful fallback when sklearn not installed

### SafeActionResolver (safety/infeasibility.py)
- Unified interface chaining Tier 1 → Tier 2 → Tier 3
- `resolve(nominal_action, state, obstacles, opponent)`: returns (safe_action, method, info)
- Tier 2 hierarchical QP first; if 'unconstrained', falls through to Tier 3 backup
- Optionally collects feasibility data for Tier 1 classifier
- Metrics tracking: n_exact, n_relaxed, n_backup, method_counts

### Tests (tests/test_infeasibility.py — 33 tests)
- **TestBackupController** (6): shape, slow speed, turns from wall, turns from obstacle, bounds, no obstacles
- **TestHierarchicalRelaxation** (7): exact, relaxes obstacles first, relaxes arena second, unconstrained, empty, preserves priority, info details
- **TestFeasibilityClassifier** (9): optimistic, collect, min_samples, both_classes, sklearn train, predict, margin sign, clear, metrics
- **TestSafeActionResolver** (7): exact safe state, backup extreme, metrics, reset, obstacles, opponent, feasibility collection
- **TestInfeasibilityEndToEnd** (4): 200-step rollout always produces action, exact rate >90%, hierarchy order, speed benchmark

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `safety/infeasibility.py` | Created | 3-tier infeasibility handling system |
| `tests/test_infeasibility.py` | Created | 33 infeasibility tests |
| `docs/worklogs/2026-02-22_S23.md` | Created | This worklog |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Tier 3 as fallback for 'unconstrained' Tier 2 result | Better than clipped nominal — actively avoids danger |
| SVM with RBF kernel + balanced weights | Handles imbalanced data; RBF captures nonlinear boundary |
| Optimistic (True) when untrained | Safe default — allows learning before constraining |
| sklearn as optional dependency | Tier 1 degrades gracefully without it |
| Priority: COLLISION > ARENA > OBSTACLE | Physical safety > containment > obstacle avoidance |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| None | Clean implementation with all 33 tests passing |

## Next Steps
- [ ] Session 7: Safety-Constrained Self-Play Training

## Metrics
- Files changed: 3
- Tests added: 33
- Total collected: 228 (213 passed, 14 skipped, 1 pre-existing SB3 failure)
