# Session 16 — 2026-02-22

## Context
- **Phase**: Phase 1: Simulation Foundation — Session 6 (VCP-CBF Validation)
- **Branch**: main

## Objectives
- [x] VCP-CBF implementation (`safety/vcp_cbf.py`)
- [x] VCP-CBF validation tests (Tests A-K from spec)
- [x] Validation script (`scripts/validate_vcp_cbf.py`)
- [x] All 4 validation criteria pass (critical gate for Phase 2)
- [x] Update CBF config yaml

## Work Done

### VCP-CBF Implementation (safety/vcp_cbf.py)
- `compute_vcp()`: Virtual control point at distance d ahead
- `vcp_cbf_obstacle()`: Quadratic barrier for circular obstacles
- `vcp_cbf_boundary()`: 4 linear barriers for arena walls
- `solve_cbf_qp()`: scipy SLSQP solver with anisotropic weights
- `VCPCBFFilter`: Complete safety filter class with metrics tracking

### Parameter Tuning (Critical Engineering Decisions)
Three issues discovered and properly debugged during validation:

1. **d=0.05 too small**: `|a_omega/a_v| ≈ 0.005`, making omega 200x less effective
   than v for CBF constraint satisfaction. QP always braked instead of steering.
   - Fix: Increased d to 0.1 (per spec troubleshooting: "increase d, keep < 0.1m")

2. **Equal QP weights cause braking preference**: With standard ||u-u_nom||^2 objective,
   reducing v is always cheaper than changing omega when a_v >> a_omega.
   - Fix: Anisotropic weights (w_v=150, w_omega=1). KKT analysis shows:
     |delta_omega/delta_v| = |a_omega/a_v| * (w_v/w_omega)
     With w_v=150: ratio ≈ 0.02 * 150 = 3.0, crossing the 2.0 threshold.

3. **Missing robot_radius in obstacle CBF**: CBF barrier used raw obstacle radius (0.5m)
   but robot has radius 0.15m, so robot center could enter collision zone.
   - Fix: VCPCBFFilter automatically adds robot_radius to obstacle radius.

### Validation Tests (tests/test_vcp_cbf.py — 35 tests)
- **Test A**: Steering around obstacle (off-axis), steering/braking ratio > 2.0
- **Test B**: No intervention when far from obstacles, < 5% intervention rate
- **Test C**: Boundary redirect on all 4 walls
- **Test D**: a_omega nonzero for > 99% of random states
- **Test E**: VCP-CBF vs position-based CBF comparison
- **Test F**: h=0 (on boundary) — QP returns valid action
- **Test G**: h<0 (in violation) — system recovers
- **Test H**: Cardinal angles (0, π/2, π, -π/2) — no singularities
- **Test I**: Small d=0.001 — graceful degradation
- **Test J**: QP optimal for 100 random states
- **Test K**: Action bounds always respected (200 random scenarios)
- Zero collisions: 100 episodes × 100 steps with random actions + CBF
- VCP computation tests and metrics tracking tests

### Validation Script (scripts/validate_vcp_cbf.py)
All 4 criteria pass:
- Steering/braking ratio: 2.63 (threshold: > 2.0)
- |a_omega| > 1e-6: 100.00% (threshold: > 99%)
- Obstacle collisions: 0 (threshold: 0)
- Intervention rate (far): 0.00% (threshold: < 5%)

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `safety/vcp_cbf.py` | Modified | Complete VCP-CBF with weighted QP, d=0.1, w_v=150 |
| `tests/test_vcp_cbf.py` | Created | 35 validation tests (A-K + extras) |
| `scripts/validate_vcp_cbf.py` | Created | Validation report script |
| `conf/safety/cbf.yaml` | Modified | Updated d=0.1, added w_v=150, w_omega=1 |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| d=0.1 (up from 0.05) | Per spec troubleshooting; a_omega ∝ d needs sufficient magnitude |
| w_v=150, w_omega=1 | KKT analysis: steering ratio = |a_omega/a_v| * (w_v/w_omega); need w_v/w_omega ≈ 150 for ratio > 2.0 |
| Robot radius added to obstacle radius | Barrier must protect entire robot body, not just center point |
| scipy SLSQP over cvxpy | Simpler integration, no overhead for 2-variable QP |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| Exact head-on a_omega = 0 | Degenerate symmetric case; documented, tested off-axis instead |
| scipy not in venv | Installed scipy (already in requirements.txt) |

## Next Steps
- [ ] Session 7: Integration testing & cleanup

## Metrics
- Files changed: 4
- Tests added: 35 (total: 107)
- Validation criteria: 4/4 pass
