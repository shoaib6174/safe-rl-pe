# Session 20 — 2026-02-22

## Context
- **Phase**: Phase 2: Safety Integration — Session 3 (CBF-QP Solver & Safe Action Bounds)
- **Branch**: main

## Objectives
- [x] Safe action bound computation (LP-based and analytical)
- [x] Integration with VCPCBFFilter
- [x] Tests for safe bounds
- [x] Full test suite passes

## Work Done

### LP-Based Safe Bounds (compute_safe_bounds_lp)
- Solves 4 LPs (min/max v, min/max omega) using scipy linprog (HiGHS method)
- Finds the exact axis-aligned bounding box of the safe polytope
- Handles infeasibility gracefully (returns nominal bounds + flag)
- ~0.1ms per call

### Analytical Safe Bounds (compute_safe_bounds_analytical)
- Fast outer approximation: per-constraint best-case analysis
- For each constraint, picks the most helpful value of the other variable
- Gives wider bounds than LP when constraints are coupled (outer approximation)
- ~0.01ms per call, useful for training with QP as backup

### VCPCBFFilter.compute_safe_bounds()
- New method wrapping both LP and analytical implementations
- `method="analytical"` (default, fast) or `method="lp"` (exact)
- Takes state, obstacles, opponent_state — delegates to get_constraints()
- Returns ((v_min, v_max), (omega_min, omega_max), feasible)

### Tests (tests/test_safe_bounds.py — 25 tests)
- LP: empty, single-v, single-omega, infeasible, within-nominal, intersection, custom bounds, alpha scaling
- Analytical: same suite + outer approximation verification vs LP
- Consistency: uncoupled match, feasibility agreement, analytical >= LP width (20 random cases)
- VCPCBFFilter: center, near-wall tightening, LP/analytical methods, obstacles+opponent, QP consistency

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `safety/vcp_cbf.py` | Modified | Added compute_safe_bounds_lp, compute_safe_bounds_analytical, VCPCBFFilter.compute_safe_bounds() |
| `tests/test_safe_bounds.py` | Created | 25 safe bounds tests |
| `docs/worklogs/2026-02-22_S20.md` | Created | This worklog |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Analytical as outer approximation | Per-constraint best-case gives wider bounds than LP; QP serves as safety backup |
| LP uses scipy linprog HiGHS | Reliable, fast enough for evaluation; import deferred to call time |
| Default method="analytical" | Speed prioritized for training; LP available for evaluation |
| QP consistency test | Verifies QP-filtered action falls within LP safe bounds |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| Initial test assumed analytical tighter than LP | Analysis showed analytical is outer approximation; fixed tests and docstring |

## Next Steps
- [ ] Session 4: CBF-Beta Policy Integration

## Metrics
- Files changed: 3
- Tests added: 25 (total: 182)
- All 182 tests pass (132 collected locally + 50 SB3-dependent skipped in this env)
