# Session 58 — 2026-02-28

## Context
- **Phase**: Phase 3 — Partial Observability & Self-Play
- **Prior**: S57 implemented adaptive training ratio + LR dampening. RA7b/RA8 completed 10M steps — both showed evader collapse at M400, adaptive ratio mechanism fires but is structurally insufficient. Root cause: vanishing reward gradient (terminal -50 drowns 0.005/step survival), no recovery mechanism, contaminated opponent pool.

## Objectives
- [x] Implement collapse rollback (restore best checkpoint when SR < threshold)
- [x] Implement PFSP-lite (bias pool sampling toward weaker opponents when collapsing)
- [x] Add CLI args for collapse_threshold, collapse_streak_limit, --pfsp
- [x] Add tests for new features
- [ ] Launch RA9 (all 3 fixes) and RA10 (collapse + PFSP only) on niro-2

## Work Done

### Collapse Rollback
- Added `collapse_threshold` and `collapse_streak_limit` params to `AMSDRLSelfPlay.__init__`
- Tracks `best_sr_pursuer/evader` and `best_ckpt_pursuer/evader` (micro, path)
- Tracks `collapse_streak_pursuer/evader` (consecutive evals below threshold)
- When streak reaches limit: loads best checkpoint via `PPO.load()`, syncs opponent weights
- Prints `[ROLLBACK]` diagnostic with SR, threshold, and restored checkpoint info

### PFSP-lite (Prioritized Fictitious Self-Play)
- Added `sample_pfsp()` to `OpponentPool` with exponential decay weighting
- Older checkpoints (lower index) get higher weight: `w_i = exp(-bias * i/(n-1))`
- `bias_strength` parameter: 0.0 = uniform, 1.0 = moderate, 2.0 = strong bias
- Integrated into `_resample_pool_opponents_vec()` with `use_pfsp` flag
- Auto-activates when `pfsp_enabled=True` AND agent has any collapse streak > 0

### CLI Integration
- Added `--collapse_threshold` (float, default 0.0 = disabled)
- Added `--collapse_streak_limit` (int, default 3)
- Added `--pfsp` (flag, default False)
- All pass through to AMSDRLSelfPlay constructor

### Tests
- `test_collapse_rollback_disabled_by_default` — verifies threshold=0.0, streak_limit=3
- `test_pfsp_disabled_by_default` — verifies pfsp_enabled=False
- `test_amsdrl_accepts_collapse_and_pfsp_params` — custom values (0.05, 5, True)
- `test_pfsp_sample_returns_correct_count` — correct n
- `test_pfsp_sample_biases_toward_older` — statistical test (5000 samples)
- `test_pfsp_sample_zero_bias_is_uniform` — verifies uniform distribution
- `test_pfsp_sample_empty_pool_returns_none` — edge case

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `training/amsdrl.py` | Modified | Collapse rollback + PFSP integration in __init__ and _run_micro_phases |
| `training/opponent_pool.py` | Modified | Added sample_pfsp() method with exponential decay weighting |
| `scripts/train_amsdrl.py` | Modified | 3 new CLI args (collapse_threshold, collapse_streak_limit, pfsp) |
| `tests/test_opponent_pool.py` | Modified | 7 new tests (37 total in file) |
| `docs/workflow_tracker.md` | Modified | S57 update + S58 entry |
| `docs/worklogs/2026-02-28_S58.md` | Created | This worklog |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Exponential decay for PFSP weighting | Simpler than tracking win rates per checkpoint (AlphaStar-style). Older = likely weaker is a reasonable proxy |
| Collapse rollback restores best checkpoint, not random | A random policy would lose exploration progress. Best historical checkpoint preserves learned behavior |
| PFSP activates on any collapse streak > 0 | Even 1 eval below threshold should trigger easier opponents before full collapse |
| Did not change survival_bonus default | survival_bonus is already a CLI arg (default 0.0). User sets it per-run. Will use 0.03 in RA9/RA10 |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| None | — |

## Next Steps
- [ ] Push code and launch RA9 (all fixes: collapse=0.05, pfsp, survival=0.03, adaptive_ratio=0.3)
- [ ] Launch RA10 (collapse + pfsp only, no adaptive ratio, no survival bonus)
- [ ] Monitor for rollback activations and recovery behavior
- [ ] If evader still collapses: consider minimum_entropy_floor or random opponent injection

## Metrics
- Files changed: 6
- Tests added: 7 (706 total passing, 37 in opponent_pool file)
- Documents updated: 2
