# Session 25 — 2026-02-22

## Context
- **Phase**: Phase 2: Safety Integration — Session 8 (Ablation Study & Results)
- **Branch**: main

## Objectives
- [x] Hydra ablation configs (A-E)
- [x] Ablation runner script
- [x] Results compilation and comparison
- [x] Phase 2 integration tests
- [x] Full test suite passes

## Work Done

### Hydra Ablation Configs (conf/experiment/ablation_{A-E}.yaml)
- **A**: Full safe (CBF-Beta + obstacles + w5=0.05 + N13 feasibility) — `ppo_beta` algorithm
- **B**: Unsafe baseline (no CBF, no obstacles) — `ppo` algorithm, Phase 1 equivalent
- **C**: QP filter only (post-hoc safety, no Beta policy) — `ppo` algorithm, `cbf_qp_filter: true`
- **D**: CBF-Beta, no w5 (safety reward ablation) — `ppo_beta`, `safety_reward_w5: 0.0`
- **E**: CBF-Beta + w5, no N13 (feasibility ablation) — `ppo_beta`, `n13_feasibility: false`
- All configs share: 3M timesteps, 4 envs, 10 phases x 300K, `phase2-ablation` experiment group
- Wandb tags: `[phase2, ablation, config_X, description]`

### Ablation Runner Script (scripts/run_ablation.py)
- `get_ablation_configs()`: returns all 5 SafeSelfPlayConfig instances (A-E)
- `run_single_config(label, config, n_episodes, seed)`: runs one config, returns metrics dict
- `print_comparison_table()`: formatted per-run table
- `print_aggregate_table()`: mean +/- std across seeds
- `save_results()`: JSON serialization with numpy type handling
- CLI: `--configs`, `--n-episodes`, `--seeds`, `--output` flags
- Also supports Hydra multirun: `python scripts/train.py --multirun +experiment=ablation_A,...`

### Results Compilation Script (scripts/compile_ablation_results.py)
- `load_results()`: reads JSON from run_ablation.py
- `aggregate_by_config()`: groups by config label, computes mean/std across seeds
- `generate_markdown_table()`: Markdown comparison table for docs
- `generate_latex_table()`: LaTeX table for paper
- `generate_analysis()`: textual analysis comparing A vs B, A vs C, A vs D, A vs E
- `try_generate_plots()`: bar charts (capture rate, intervention rate, safety summary)
- `compile_wandb_results()`: optional wandb API integration
- CLI: `--input`, `--output-dir`, `--wandb-group` flags

### Tests (tests/test_ablation.py — 43 tests)
- **TestAblationConfigs** (8): all 5 present, each config's flags correct, env params consistent
- **TestAblationRunner** (7): each config runs, all 5 run, different seeds work
- **TestResultsCompilation** (5): aggregation, markdown table, latex table, analysis text, JSON serializable
- **TestPhase2Integration** (9): env+CBF, safety reward, resolver metrics, multi-phase tracking, full rollout with/without CBF, obs dimensions, CBF with obstacles, hierarchical relaxation
- **TestCrossConfigSafety** (5): B has no interventions, safe configs have resolver metrics, valid capture rates, non-negative violations, CBF margins
- **TestHydraConfigs** (9): all YAML exist, valid YAML, experiment group, wandb tags, per-config safety assertions

## Files Changed
| File | Action | Description |
|------|--------|-------------|
| `conf/experiment/ablation_A.yaml` | Created | Full safe config |
| `conf/experiment/ablation_B.yaml` | Created | Unsafe baseline config |
| `conf/experiment/ablation_C.yaml` | Created | QP filter only config |
| `conf/experiment/ablation_D.yaml` | Created | No safety reward config |
| `conf/experiment/ablation_E.yaml` | Created | No feasibility config |
| `scripts/run_ablation.py` | Created | Ablation runner script |
| `scripts/compile_ablation_results.py` | Created | Results compilation + plots |
| `tests/test_ablation.py` | Created | 43 tests |
| `docs/worklogs/2026-02-22_S25.md` | Created | This worklog |

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| 5 configs (A-E) instead of 4 (A-D) | Spec calls for E to isolate N13 feasibility contribution |
| SB3-independent runner using safe_self_play_rollout | Testable locally without SB3; Hydra multirun for full training |
| Both Markdown + LaTeX table output | Markdown for docs, LaTeX for paper |
| Matplotlib optional for plots | Graceful fallback if not installed |

## Issues & Blockers
| Issue | Resolution |
|-------|------------|
| CBFConstraint constructor uses `a_v, a_omega` not `a, b` | Fixed test to use correct field names |

## Next Steps
- [ ] Phase 2 complete — move to Phase 3: Self-Play & Opponent Modeling

## Metrics
- Files changed: 9
- Tests added: 43
- Total collected: 290 passed, 14 skipped, 1 pre-existing SB3 failure
